gt_stack_rebase() {
  if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    echo "Usage: gt_stack_rebase [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  checkout    Check out pnpm-lock.yaml from main and run pnpm i (default)"
    echo "  install     Run pnpm i and let pnpm resolve the conflicts"
    echo "  --edit-msg  Edit commit messages during rebase"
    echo "  --dry-run   Show what would be done without making changes"
    echo ""
    echo "Examples:"
    echo "  gt_stack_rebase              # Auto-resolve pnpm-lock conflicts"
    echo "  gt_stack_rebase install      # Use pnpm to resolve conflicts"
    echo "  gt_stack_rebase --dry-run    # Preview conflict resolution"
    return 0
  fi

  local should_checkout=true
  local edit_msg=false
  local dry_run=false

  # Parse arguments
  for arg in "$@"; do
    case $arg in
      checkout)
        should_checkout=true
        ;;
      install)
        should_checkout=false
        ;;
      --edit-msg|edit-msg)
        edit_msg=true
        ;;
      --dry-run)
        dry_run=true
        ;;
    esac
  done

  if $dry_run; then
    echo "ğŸ” DRY RUN: Checking rebase state..."
  fi

  local iteration=0
  while git rebase --show-current-patch &> /dev/null; do
    ((iteration++))
    # Get list of files with merge conflicts
    local conflict_files=$(git diff --name-only --diff-filter=U)

    if $dry_run; then
      echo ""
      echo "[$iteration] Conflict detected:"
      echo "  Files: ${conflict_files:-none}"
    fi

    # Check if the only conflict is in the pnpm-lock.yaml
    if [[ "$conflict_files" == "pnpm-lock.yaml" ]]; then
      if $dry_run; then
        echo "  âœ… Only pnpm-lock.yaml conflict - would auto-resolve"
        if $should_checkout; then
          echo "  ğŸ“‹ Would run: git checkout main pnpm-lock.yaml"
        fi
        echo "  ğŸ“‹ Would run: pnpm i"
        echo "  ğŸ“‹ Would run: git add pnpm-lock.yaml"
        if $edit_msg; then
          echo "  ğŸ“‹ Would run: git rebase --continue (with editor)"
        else
          echo "  ğŸ“‹ Would run: git rebase --continue (skip editor)"
        fi
        echo ""
        echo "ğŸ” DRY RUN: Cannot continue simulation without actual rebase"
        echo "ğŸ’¡ Run without --dry-run to perform the rebase"
        return 0
      fi

      echo "Resolving merge conflict in pnpm-lock.yaml..."
      # Resolve the conflict
      if $should_checkout; then
        git checkout main pnpm-lock.yaml || true
      fi
      pnpm i
      git add pnpm-lock.yaml

      if $edit_msg; then
        git rebase --continue
      else
        GIT_EDITOR=true git rebase --continue
      fi
    else
      # Stop the script for manual conflict resolution
      if $dry_run; then
        echo "  âŒ Non-pnpm-lock conflicts - would require manual resolution"
        return 0
      fi
      echo "Merge conflict detected in a file other than pnpm-lock.yaml. Please resolve manually."
      echo "$conflict_files"
      return 1
    fi
  done

  if $dry_run; then
    if [[ $iteration -eq 0 ]]; then
      echo "â„¹ï¸  No rebase in progress or no conflicts to resolve"
    fi
  fi
}
