# Safely delete merged and squash-merged branches while protecting worktrees
#
# This function uses git for-each-ref instead of parsing git branch output
# to avoid issues with formatted output, worktrees, and special characters.
#
# Usage: git_prune_squash_merged [--dry-run|-n|--yes|-y|--help|-h]
#
# Options:
#   --dry-run, -n    Show what would be deleted without actually deleting
#   --yes, -y        Skip confirmation prompt
#   --help, -h       Show this help message
#
# Protected branches: main, master, develop, production (and current branch)
# Worktree branches are automatically protected from deletion.
#
# The function performs two steps:
#   1. Delete normally merged branches (git merge)
#   2. Delete squash-merged branches (git merge --squash)
git_prune_squash_merged() {
  # Parse arguments first to handle help
  if [[ "$1" == "--help" || "$1" == "-h" ]]; then
    echo "git_prune_squash_merged - Safely delete merged and squash-merged branches"
    echo ""
    echo "Usage: git_prune_squash_merged [--dry-run|-n|--yes|-y|--help|-h]"
    echo ""
    echo "Options:"
    echo "  --dry-run, -n    Show what would be deleted without actually deleting"
    echo "  --yes, -y        Skip confirmation prompt"
    echo "  --help, -h       Show this help message"
    echo ""
    echo "Features:"
    echo "  ‚Ä¢ Uses git for-each-ref for robust parsing (no issues with terminal formatting)"
    echo "  ‚Ä¢ Automatically protects worktree branches from deletion"
    echo "  ‚Ä¢ Protects current branch and main branches: main, master, develop, production"
    echo "  ‚Ä¢ Handles both normally merged and squash-merged branches"
    echo "  ‚Ä¢ Safe dry-run mode to preview changes"
    echo ""
    echo "Examples:"
    echo "  git_prune_squash_merged --dry-run    # Preview what would be deleted"
    echo "  git_prune_squash_merged              # Delete with confirmation"
    echo "  git_prune_squash_merged --yes        # Delete without confirmation"
    echo "  gpsm --dry-run                       # Using alias"
    return 0
  fi

  # Safety: ensure we're in a git repository
  if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "‚ùå Error: Not in a git repository"
    return 1
  fi

  # Configuration - can be customized by setting environment variables
  local protected_branches=(${GIT_PRUNE_PROTECTED_BRANCHES:-"main" "master" "develop" "production"})
  local current_branch=$(git symbolic-ref --short HEAD 2>/dev/null)
  local dry_run=false
  local skip_confirm=false

  # Parse arguments
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --dry-run|-n)
        dry_run=true
        shift
        ;;
      --yes|-y)
        skip_confirm=true
        shift
        ;;
      *)
        echo "‚ùå Unknown option: $1"
        echo "Run with --help for usage information"
        return 1
        ;;
    esac
  done

  echo "üîç Analyzing merged branches..."
  echo "Current branch: $current_branch"
  echo "Protected branches: ${protected_branches[@]}"
  echo ""

  # Arrays to collect branches to delete
  local -a merged_branches=()
  local -a squash_merged_branches=()

  # Step 1: Find normally merged branches
  echo "üìã Step 1: Finding normally merged branches..."
  while IFS=$'\0' read -r branch worktree_path; do
    [[ -z "$branch" ]] && continue
    [[ "$branch" == "$current_branch" ]] && continue

    local is_protected=false
    for protected in "${protected_branches[@]}"; do
      [[ "$branch" == "$protected" ]] && is_protected=true && break
    done
    [[ "$is_protected" == true ]] && continue
    [[ -n "$worktree_path" ]] && continue

    merged_branches+=("$branch")
  done < <(git for-each-ref --format='%(refname:short)%00%(worktreepath)' --merged=HEAD refs/heads/)

  echo ""
  echo "üìã Step 2: Finding squash-merged branches..."

  # Step 2: Find squash-merged branches
  local original_branch=$current_branch
  if [[ "$current_branch" != "main" ]]; then
    git checkout -q main 2>/dev/null
  fi

  while IFS=$'\0' read -r branch worktree_path; do
    [[ -z "$branch" ]] && continue
    [[ "$branch" == "main" ]] && continue

    local is_protected=false
    for protected in "${protected_branches[@]}"; do
      [[ "$branch" == "$protected" ]] && is_protected=true && break
    done
    [[ "$is_protected" == true ]] && continue
    [[ -n "$worktree_path" ]] && continue

    # Skip if already merged (handled in step 1)
    git merge-base --is-ancestor "$branch" HEAD 2>/dev/null && continue

    # Check if squash-merged
    local merge_base=$(git merge-base main "$branch" 2>/dev/null)
    if [[ -n "$merge_base" ]]; then
      local commit_tree=$(git commit-tree $(git rev-parse "$branch^{tree}") -p "$merge_base" -m "_" 2>/dev/null)
      if [[ -n "$commit_tree" ]] && [[ $(git cherry main "$commit_tree" 2>/dev/null) == "-"* ]]; then
        squash_merged_branches+=("$branch")
      fi
    fi
  done < <(git for-each-ref --format='%(refname:short)%00%(worktreepath)' refs/heads/)

  # Switch back to original branch
  if [[ "$current_branch" != "main" ]] && [[ "$original_branch" != "main" ]]; then
    git checkout -q "$original_branch" 2>/dev/null
  fi

  # Show results
  echo ""
  local total_count=$(( ${#merged_branches[@]} + ${#squash_merged_branches[@]} ))

  if [[ $total_count -eq 0 ]]; then
    echo "‚ú® No merged branches to delete."
    return 0
  fi

  echo "Found $total_count branch(es) to delete:"
  echo ""

  if [[ ${#merged_branches[@]} -gt 0 ]]; then
    echo "Merged branches:"
    for branch in "${merged_branches[@]}"; do
      echo "  ‚Ä¢ $branch"
    done
  fi

  if [[ ${#squash_merged_branches[@]} -gt 0 ]]; then
    echo "Squash-merged branches:"
    for branch in "${squash_merged_branches[@]}"; do
      echo "  ‚Ä¢ $branch"
    done
  fi

  echo ""

  # Dry run: just show what would be deleted
  if [[ "$dry_run" == true ]]; then
    echo "üîç DRY RUN complete. Run without --dry-run to actually delete branches."
    return 0
  fi

  # Ask for confirmation unless --yes was passed
  if [[ "$skip_confirm" != true ]]; then
    echo -n "Delete these $total_count branch(es)? [y/N] "
    read -r response
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
      echo "‚ùå Aborted."
      return 0
    fi
  fi

  echo ""
  echo "üóëÔ∏è  Deleting branches..."

  local deleted_count=0

  # Delete merged branches
  for branch in "${merged_branches[@]}"; do
    if git branch -d "$branch" 2>/dev/null; then
      echo "  ‚úÖ Deleted: $branch"
      ((deleted_count++))
    else
      echo "  ‚ö†Ô∏è  Failed to delete: $branch"
    fi
  done

  # Delete squash-merged branches (need -D since not technically merged)
  for branch in "${squash_merged_branches[@]}"; do
    if git branch -D "$branch" 2>/dev/null; then
      echo "  ‚úÖ Deleted: $branch"
      ((deleted_count++))
    else
      echo "  ‚ö†Ô∏è  Failed to delete: $branch"
    fi
  done

  echo ""
  echo "üèÅ Branch cleanup complete!"
  echo "   ‚úÖ Deleted $deleted_count of $total_count branches"
}
